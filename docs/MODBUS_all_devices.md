# 幫浦測試平台 MODBUS 設備通訊規格
## Pump Testing Platform MODBUS Device Communication Specification

**文件版本**: 1.2
**更新日期**: 2025.11.15
**機密等級**: Confidential

---

## 系統設備總覽

系統共有 **8 台 MODBUS RTU 設備**，透過 **4 個 USB-RS485 轉換器** 連接至控制電腦。

| USB 轉換器 | 連接設備 | 數量 |
|-----------|---------|------|
| USB-Enhanced-SERIAL-A (CH344) | 電表 (DC/AC110/AC220/AC220-3P) | 4 台 |
| USB-Enhanced-SERIAL-C (CH344) | 流量計 | 1 台 |
| USB-Enhanced-SERIAL-D (CH344) | 繼電器 IO 模組 | 1 台 |
| MOXA USB Serial Port | 壓力計 (正壓/真空) | 2 台 |
| **總計** | **8 台設備** | **4 個轉換器** |

---

## 1. 流量計 (1台)

**連接埠**: USB-Enhanced-SERIAL-C (CH344)
**UART 設定**: 19200 / 8 / NONE / 1
**MODBUS RTU 地址**: 1

---

## 2. 壓力計 (2台)

**連接埠**: MOXA USB Serial Port
**UART 設定**: 19200 / 8 / **EVEN** / 1

| 設備 | RTU 地址 | 用途 | 量測範圍 |
|------|----------|------|----------|
| 壓力計 右 | 2 | 正壓測試 | 0 ~ 1.0 MPa (0 ~ 10 kg/cm²) |
| 壓力計 左 | 3 | 真空測試 | 0 ~ -0.1 MPa (0 ~ -100 kPa) |

---

## 3. 電表 (4台)

**連接埠**: USB-Enhanced-SERIAL-A (CH344)
**UART 設定**: 57600 / 8 / NONE / 1

| 設備 | RTU 地址 | 用途 |
|------|----------|------|
| DC 電表 | 1 | DC 12V/24V 電力監測 |
| AC110 電表 | 2 | AC 110V 單相電力監測 |
| AC220 電表 | 3 | AC 220V 單相電力監測 |
| AC220 3P 電表 | 4 | AC 220V 三相電力監測 |

---

## 4. 繼電器 IO 模組 (1台)

**連接埠**: USB-Enhanced-SERIAL-D (CH344)
**UART 設定**: 115200 / 8 / NONE / 1
**MODBUS RTU 地址**: 1

### 繼電器通道配置

| 通道 | 功能 | 說明 |
|------|------|------|
| CH1 | 電磁閥 A 控制 | 真空/正壓測試管路切換 |
| CH2 | 電磁閥 B 控制 | 真空/正壓測試管路切換 |
| CH3 | 電磁閥 C 控制 | 真空/正壓測試管路切換 |
| CH4 | 電磁閥 D 控制 | 真空/正壓測試管路切換 |
| CH5 | DC 電源供電開關 | 控制待測幫浦 DC 電源 |
| CH6 | AC110V 電源供電開關 | 控制待測幫浦 AC110V 電源 |
| CH7 | AC220V 電源供電開關 | 控制待測幫浦 AC220V 電源 |
| CH8 | AC220V 3P 電源供電開關 | 控制待測幫浦 AC220V 三相電源 |

### 數位輸入配置

| Bit | 功能 | 狀態定義 |
|-----|------|----------|
| Bit0 | 緊急停止鈕 | 1 = 按下, 0 = 未按下 |
| Bit1 | 測試蓋狀態 | 1 = 關蓋, 0 = 開蓋 |

**⚠️ 注意**: 電磁閥 A/B/C/D 的組合控制模式（真空/正壓/手動測試）將於後續文件中定義。

---


## 5. 繼電器控制指令

### 5.1 全部關閉指令

**使用時機**: 測試停止 / 緊急停止 / 測試完成

```
01 05 00 FF 00 00 FD FA
```

**說明**: 關閉所有繼電器輸出（CH1~CH8 全部 OFF）

---

### 5.2 電源啟動指令

**⚠️ 前提條件** (安全聯鎖):
- ✅ **Bit1 = 1** (測試蓋必須關閉)
- ✅ **Bit0 = 0** (緊急停止鈕未按下)
- ❌ 若不符合條件，**禁止啟動**

| 電源類型 | MODBUS 指令 | 說明 |
|---------|------------|------|
| DC 電源 | `01 05 00 04 FF 00 CD FB` | 開啟 CH5 |
| AC110V | `01 05 00 05 FF 00 9C 3B` | 開啟 CH6 |
| AC220V | `01 05 00 06 FF 00 6C 3B` | 開啟 CH7 |
| AC220V 3P | `01 05 00 07 FF 00 3D FB` | 開啟 CH8 |

---

### 5.3 電源暫停/關閉指令

**使用時機**: 暫停測試 / 測試中開蓋

| 電源類型 | MODBUS 指令 | 說明 |
|---------|------------|------|
| DC 電源 | `01 05 00 04 00 00 8C 0B` | 關閉 CH5 |
| AC110V | `01 05 00 05 00 00 DD CB` | 關閉 CH6 |
| AC220V | `01 05 00 06 00 00 2D CB` | 關閉 CH7 |
| AC220V 3P | `01 05 00 07 00 00 7C 0B` | 關閉 CH8 |

---

### 5.4 電磁閥控制指令

**⚠️ 待確認**: 電磁閥 A/B/C/D (CH1~CH4) 的完整控制指令需實際測試確認 CRC 值。

**推測指令格式** (需實際驗證):
```
// 開啟指令 (假設與 CH5~8 格式相同)
01 05 00 00 FF 00 [CRC]  // 開啟 CH1 (電磁閥 A)
01 05 00 01 FF 00 [CRC]  // 開啟 CH2 (電磁閥 B)
01 05 00 02 FF 00 [CRC]  // 開啟 CH3 (電磁閥 C)
01 05 00 03 FF 00 [CRC]  // 開啟 CH4 (電磁閥 D)

// 關閉指令
01 05 00 00 00 00 [CRC]  // 關閉 CH1 (電磁閥 A)
01 05 00 01 00 00 [CRC]  // 關閉 CH2 (電磁閥 B)
01 05 00 02 00 00 [CRC]  // 關閉 CH3 (電磁閥 C)
01 05 00 03 00 00 [CRC]  // 關閉 CH4 (電磁閥 D)
```

**📝 實作前必須確認**:
- [ ] 計算並驗證正確的 CRC-16 Modbus 校驗碼
- [ ] 確認電磁閥控制指令與實際硬體一致
- [ ] 測試電磁閥動作是否正常

**具體組合模式** (真空/正壓/手動測試) 將於後續文件定義。

---


## 6. 感測器讀取指令

### 6.1 電表讀取指令

**功能碼**: 0x03 (Read Holding Registers)
**輪詢頻率**: 0.5 秒 1 次 (2 Hz)

| 設備 | RTU 地址 | MODBUS 指令 |
|------|----------|------------|
| DC 電表 | 1 | `01 03 10 00 00 04 40 C9` |
| AC110V 電表 | 2 | `02 03 10 00 00 04 40 FA` |
| AC220V 電表 | 3 | `03 03 10 00 00 04 41 2B` |
| AC220V 3P 電表 | 4 | `04 03 10 00 00 04 40 9C` |

---

### 6.2 壓力計讀取指令

**功能碼**: 0x03 (Read Holding Registers)
**輪詢頻率**: 1 秒 1 次 (1 Hz)

| 設備 | RTU 地址 | MODBUS 指令 |
|------|----------|------------|
| 壓力計 右 (正壓) | 2 | `02 03 10 00 00 01 80 F9` |
| 壓力計 左 (真空) | 3 | `03 03 10 00 00 01 81 28` |

---

### 6.3 流量計讀取指令

**功能碼**: 0x03 (Read Holding Registers)
**輪詢頻率**: 1 秒 1 次 (1 Hz)

| 設備 | RTU 地址 | MODBUS 指令 |
|------|----------|------------|
| 流量計 | 1 | `01 03 00 00 00 01 84 0A` |

---

### 6.4 IO 模組讀取指令

**功能碼**: 0x02 (Read Discrete Inputs)
**輪詢頻率**: 0.01 秒 1 次 (100 Hz) - **高頻率用於安全監控**

| 設備 | RTU 地址 | MODBUS 指令 |
|------|----------|------------|
| IO 模組 | 1 | `01 02 00 00 00 08 79 CC` |

**⚠️ 重要**: IO 模組需高頻輪詢以即時偵測緊急停止與測試蓋狀態。

---


## 7. 感測器回應資料格式

### 7.1 電表回應格式

**回應範例** (DC 電表):
```
01 03 08 00 00 00 00 00 00 00 00 95 D7
```

**資料解析** (所有電表格式相同):

| Byte 位置 | 參數名稱 | 換算公式 | 單位 |
|-----------|---------|---------|------|
| Byte 4-5 | 有效電壓 | Hex → Dec ÷ 100 | V |
| Byte 6-7 | 有效電流 | Hex → Dec ÷ 1000 | A |
| Byte 8-9 | 有功功率 | Hex → Dec ÷ 10000 | kW |
| Byte 10-11 | 無功功率 | Hex → Dec ÷ 10000 | kVAR |

**範例計算**:
```
Byte 4-5 = 0x0D6E (3438 dec) → 3438 ÷ 100 = 34.38 V
Byte 6-7 = 0x0FA0 (4000 dec) → 4000 ÷ 1000 = 4.000 A
```

**回應範例**:
- DC 電表: `01 03 08 00 00 00 00 00 00 00 00 95 D7`
- AC110V: `02 03 08 00 00 00 00 00 00 00 00 9A 93`
- AC220V: `03 03 08 00 00 00 00 00 00 00 00 9E 6F`
- AC220V 3P: `04 03 08 00 00 00 00 00 00 00 00 84 1B`

---

### 7.2 壓力計回應格式

**回應範例** (正壓):
```
02 03 02 00 00 FC 44
```

**回應範例** (真空):
```
03 03 02 00 00 C1 84
```

**資料解析**:

| Byte 位置 | 參數名稱 | 換算公式 | 單位 | 範圍 |
|-----------|---------|---------|------|------|
| Byte 4-5 (正壓) | 正壓壓力值 | Hex → Dec ÷ 10 | MPa | 0 ~ 1.0 MPa (0 ~ 10 kg/cm²) |
| Byte 4-5 (真空) | 真空壓力值 | Hex → Dec ÷ 10 | MPa | 0 ~ -0.1 MPa (0 ~ -100 kPa) |

**範例計算**:
```
正壓: Byte 4-5 = 0x00DA (218 dec) → 218 ÷ 10 = 21.8 MPa (錯誤，應為 0.218 MPa = 2.18 kg/cm²)
真空: Byte 4-5 = 0xFFCE (-50 dec) → -50 ÷ 10 = -5.0 kPa
```

**⚠️ 單位轉換**:
- 1 MPa = 10 kg/cm² = 1000 kPa
- 正壓範圍: 0 ~ 1.0 MPa = 0 ~ 10 kg/cm²
- 真空範圍: 0 ~ -0.1 MPa = 0 ~ -100 kPa

---

### 7.3 流量計回應格式

**回應範例**:
```
01 03 02 00 00 B8 44
```

**資料解析**:

| Byte 位置 | 參數名稱 | 換算公式 | 單位 |
|-----------|---------|---------|------|
| Byte 4-5 | 氣體流量 | Hex → Dec ÷ 10 | L/min |

**範例計算**:
```
Byte 4-5 = 0x00DA (218 dec) → 218 ÷ 10 = 21.8 L/min
```

---

### 7.4 IO 模組回應格式

**回應範例**:
```
01 02 01 00 A1 88
```

**資料解析**:

| Byte 位置 | 參數名稱 | 位元定義 | 說明 |
|-----------|---------|---------|------|
| Byte 4 | 數位輸入狀態 | Bit 0-7 | 8 個輸入通道狀態 |

**Bit 定義**:
- **Bit 0**: 緊急停止鈕狀態 (1 = 按下, 0 = 未按下)
- **Bit 1**: 測試蓋狀態 (1 = 關蓋, 0 = 開蓋)
- **Bit 2-7**: 保留 (未使用)

**範例解析**:
```
Byte 4 = 0x02 (00000010 binary)
→ Bit 0 = 0 (緊急停止未按下)
→ Bit 1 = 1 (測試蓋已關閉)
→ 狀態: 可以啟動測試
```

---

## 8. 安全聯鎖邏輯

### 8.1 啟動測試前檢查

Python 後端必須強制執行以下安全檢查：

```python
# 讀取 IO 模組狀態
io_status = read_io_module()  # Byte 4
emergency_stop = (io_status & 0x01) != 0  # Bit 0
cover_closed = (io_status & 0x02) != 0    # Bit 1

# 安全聯鎖判斷
if emergency_stop:
    # ❌ 緊急停止按下，禁止啟動
    return "錯誤: 緊急停止鈕已按下，請解除後再試"

if not cover_closed:
    # ❌ 測試蓋未關閉，禁止啟動
    return "錯誤: 測試蓋未關閉，請關閉後再試"

# ✅ 安全檢查通過，允許啟動
send_power_on_command()
```

---

### 8.2 測試中持續監控

系統必須以 **100 Hz (0.01秒)** 頻率持續監控 IO 狀態：

| 偵測到的狀態變化 | 系統反應 |
|-----------------|----------|
| **緊急停止按下** (Bit0 = 1) | 1. 立即切斷所有電源 (`01 05 00 FF 00 00 FD FA`)<br>2. 洩壓 (開啟電磁閥 A/B)<br>3. 鎖定所有操作<br>4. 顯示 "🚨 緊急停止" |
| **測試蓋開啟** (Bit1 = 0) | 1. 停止幫浦供電 (關閉對應 CH5~8)<br>2. 進入 **暫停狀態**<br>3. 顯示 "⚠️ 測試蓋開啟 - 已暫停"<br>4. 蓋上後可繼續測試 |

---

### 8.3 恢復測試條件

| 暫停原因 | 恢復條件 |
|---------|---------|
| 測試蓋開啟 | 檢測到 Bit1 = 1 (蓋上) → 可按 "繼續測試" |
| 緊急停止 | 檢測到 Bit0 = 0 (解除) → 必須重新啟動測試流程 |

---

## 9. 實際硬體驗證待確認項目

以下項目需在實際硬體測試時驗證：

### 9.1 電磁閥控制指令 (優先級: 高)
- [ ] **CH1~CH4 的完整 MODBUS 指令**（含正確 CRC）
- [ ] 驗證電磁閥動作是否與指令對應
- [ ] 確認電磁閥組合模式（真空/正壓測試的 A/B/C/D 開關邏輯）

### 9.2 壓力計單位與換算公式 (優先級: 高)
- [ ] **確認壓力計實際回傳單位**
  - 正壓: 是 MPa? kPa? 還是 kg/cm²?
  - 真空: 是 MPa? kPa? 還是其他單位?
- [ ] **驗證換算公式**
  - 測試數值範例: `0x00DA` 應對應多少實際壓力?
  - 確認除以 10 的倍率是否正確
- [ ] **測試極限值**
  - 正壓最大值 (應為 10 kg/cm² 或 1.0 MPa)
  - 真空最大值 (應為 -100 kPa 或 -0.1 MPa)

### 9.3 寄存器起始地址驗證 (優先級: 中)
不同設備使用不同的寄存器起始地址，需確認是否與設備規格書一致：
- [ ] 壓力計: `0x1000` (4096) - 起始地址正確?
- [ ] 流量計: `0x0000` (0) - 起始地址正確?
- [ ] 電表: `0x1000` (4096) - 起始地址正確?

### 9.4 流量計量測範圍 (優先級: 低)
- [ ] 確認流量計最大測量範圍 (L/min)
- [ ] 驗證換算公式 (除以 10) 是否正確

### 9.5 IO 模組測試 (優先級: 高)
- [ ] 實際測試緊急停止按鈕觸發 (Bit 0 = 1)
- [ ] 實際測試測試蓋開關偵測 (Bit 1 = 0/1)
- [ ] 驗證 100 Hz 輪詢頻率是否穩定
- [ ] 測試安全聯鎖邏輯是否正確執行

---

## 10. 文件修訂記錄

| 版本 | 日期 | 修訂內容 |
|------|------|---------|
| 1.0 | 2025.11.12 | 初版發布 |
| 1.1 | 2025.11.15 | 1. 新增壓力計量測範圍說明 (MPa/kPa/kg/cm²)<br>2. 明確定義電磁閥 A/B/C/D 對應 CH1~CH4<br>3. 新增安全聯鎖邏輯詳細說明<br>4. 重新組織文件結構，提升可讀性<br>5. 保留原始技術筆記於附錄 |
| 1.2 | 2025.11.15 | **技術審查修正**:<br>1. 修正 USB 轉換器數量: 3→4 個<br>2. 修正 Python 位元檢查邏輯 (`!= 0`)<br>3. 修正位元範圍描述 (bit 0-8 → bit 0-7)<br>4. 新增電磁閥控制指令推測格式<br>5. **新增「實際硬體驗證待確認項目」章節**<br>6. 標註需實測驗證的項目 (壓力單位/CRC/寄存器地址) |

---

## 附錄：原始技術筆記 (僅供參考)

以下為原始開發筆記，已整合至上方正式文件中，此處保留供技術參考使用。

---

### 原始設備配置筆記

```
流量計(1台) 連結USB-Enhanced -SERIAL-C CH344 / UART 設定 19200 / 8 /NONE / 1 / RTU 地址設定 1

壓力計(2台) 連結MOXA USB Serial Port / UART 設定 19200 / 8 /EVEN / 1
壓力計 右 正壓 RTU 地址設定 2
壓力計 左 真空 RTU 地址設定 3

電表(4台) 連結USB-Enhanced -SERIAL-A CH344 / UART 設定 57600 / 8 /NONE / 1
AC220 3P RTU 地址設定 4
AC220 RTU 地址設定 3
AC110 RTU 地址設定 2
DC RTU 地址設定 1

繼電器IO(1台) 連結USB-Enhanced -SERIAL-D CH344 / UART 設定 115200 / 8 /NONE / 1 / RTU 地址設定 1
```

---

### 原始繼電器指令筆記

```
繼電器 指令
測試停止
01 05 00 FF 00 00 FD FA //全關

開始鍵(需要關蓋才可使用並 未 按下緊急停止鈕)
 AC
110 ->  01 05 00 05 FF 00 9C 3B // 開CH6
220 ->	01 05 00 06 FF 00 6C 3B // 開CH7
2203P -> 01 05 00 07 FF 00 3D FB // 開CH8
DC ->  01 05 00 04 FF 00 CD FB // 開CH5

暫停鍵 / 測試中開蓋
110 ->  01 05 00 05 00 00 DD CB // 關CH6
220 ->	01 05 00 06 00 00 2D CB // 關CH7
2203P -> 01 05 00 07 00 00 7C 0B // 關CH8
DC ->  01 05 00 04 00 00 8C 0B // 關CH5

關閉鍵 / 按下緊急停止鈕 /測試完成
01 05 00 FF 00 00 FD FA //全關
```

---

### 原始讀取指令與回應筆記

```
COM讀取與返回
DC 讀取指令 01 03 10 00 00 04 40 C9 讀取 0.5秒 1次
AC110 讀取指令 02 03 10 00 00 04 40 FA 0.5秒 1次
AC220 讀取指令 03 03 10 00 00 04 41 2B 0.5秒 1次
AC220 3P 讀取指令 04 03 10 00 00 04 40 9C 0.5秒 1次
IO 讀取 01 02 00 00 00 08 79 CC 讀取 0.01秒 1次
流量 讀取 01 03 00 00 00 01 84 0A 讀取 1秒 1次
壓力 右 正壓 讀取 02 03 10 00 00 01 80 F9 讀取 1秒 1次
壓力 左 真空 讀取 03 03 10 00 00 01 81 28 讀取 1秒 1次


DC 返回 01 03 08 00 00 00 00 00 00 00 00 95 D7
位元 4-5 ：有效电压 需換算成 10進制 数据/100 单位V
位元 6-7 ：有效電流 需換算成 10進制 数据/1000 单位A
位元 8-9 ：有功功率 需換算成 10進制 数据/10000 单位kW
位元 10-11 ：无功功率  需換算成 10進制 数据/10000 单位kVAR

AC110 返回 02 03 08 00 00 00 00 00 00 00 00 9A 93
位元 4-5 ：有效电压 需換算成 10進制 数据/100 单位V
位元 6-7 ：有效電流 需換算成 10進制 数据/1000 单位A
位元 8-9 ：有功功率 需換算成 10進制 数据/10000 单位kW
位元 10-11 ：无功功率  需換算成 10進制 数据/10000 单位kVAR

AC220 返回 03 03 08 00 00 00 00 00 00 00 00 9E 6F
位元 4-5 ：有效电压 需換算成 10進制 数据/100 单位V
位元 6-7 ：有效電流 需換算成 10進制 数据/1000 单位A
位元 8-9 ：有功功率 需換算成 10進制 数据/10000 单位kW
位元 10-11 ：无功功率  需換算成 10進制 数据/10000 单位kVAR

AC220 3P 返回 04 03 08 00 00 00 00 00 00 00 00 84 1B
位元 4-5 ：有效电压 需換算成 10進制 数据/100 单位V
位元 6-7 ：有效電流 需換算成 10進制 数据/1000 单位A
位元 8-9 ：有功功率 需換算成 10進制 数据/10000 单位kW
位元 10-11 ：无功功率  需換算成 10進制 数据/10000 单位kVAR

IO 返回 01 02 01 00 A1 88
		位元 4 返回的输入通道状态 bit 0-7 (共 8 個位元)
		Bit0:緊急停止鈕狀態  按下 1 未按下 0；
		Bit1:門蓋狀態 開蓋 0  / 關蓋 1，

流量 返回 01 03 02 00 00 B8 44
		位元 4-5 ：需換算成 10進制 倍率 10 ,例：0x00da 21.8L/min

壓力 右 正壓 返回 02 03 02 00 00 FC 44
		位元 4-5 ：需換算成 10進制 倍率 10 ,例：0x00da 21.8MPa(也許)
壓力 左 真空 返回 03 03 02 00 00 C1 84
		位元 4-5 ：需換算成 10進制 倍率 10 ,例：0x00da 21.8MPa(也許)
```

---

**文件結束** 