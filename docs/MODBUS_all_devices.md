# 幫浦測試平台 MODBUS 設備通訊規格
## Pump Testing Platform MODBUS Device Communication Specification

**文件版本**: 1.9
**更新日期**: 2025.11.15
**機密等級**: Confidential

---

## 系統設備總覽

系統共有 **8 台 MODBUS RTU 設備**，透過 **4 個 USB-RS485 轉換器** 連接至控制電腦。

| USB 轉換器 | 連接設備 | 數量 |
|-----------|---------|------|
| USB-Enhanced-SERIAL-A (CH344) | 電表 (DC/AC110/AC220/AC220-3P) | 4 台 |
| USB-Enhanced-SERIAL-C (CH344) | 流量計 | 1 台 |
| USB-Enhanced-SERIAL-D (CH344) | 繼電器 IO 模組 | 1 台 |
| MOXA USB Serial Port | 壓力計 (正壓/真空) | 2 台 |
| **總計** | **8 台設備** | **4 個轉換器** |

---

## 1. 流量計 (1台)

**連接埠**: USB-Enhanced-SERIAL-C (CH344)
**UART 設定**: 19200 / 8 / NONE / 1
**MODBUS RTU 地址**: 1

**設備規格**: AFM07 系列數顯氣體質量流量計
**參考文檔**: `AFM07系列数显气体质量流量计说明书（中文版 ）1118.pdf`

---

## 2. 壓力計 (2台)

**連接埠**: MOXA USB Serial Port
**UART 設定**: 19200 / 8 / **EVEN** / 1

**設備規格**: Delta DPA 系列壓力感測器 (RS485)
**參考文檔**: `Delta-DPA-Series-Pressure-Sensor-RS485-Instruction-Sheet.pdf`

| 設備 | RTU 地址 | 用途 | 量測範圍 |
|------|----------|------|----------|
| 壓力計 右 | 2 | 正壓測試 | 0 ~ 1.0 MPa (0 ~ 10 kg/cm²) |
| 壓力計 左 | 3 | 真空測試 | 0 ~ -0.1 MPa (0 ~ -100 kPa) |

---

## 3. 電表 (4台)

**連接埠**: USB-Enhanced-SERIAL-A (CH344)
**UART 設定**: 57600 / 8 / NONE / 1

**設備規格**: 
- **單相電表** (DC/AC110V/AC220V): JX3101 系列交流/直流采集器
- **三相電表** (AC220V 3P): JX8304M 三相交流采集器

**參考文檔**: 
- `JX3101-7101-7102-7202-采集器说明文档.pdf` (單相電表)
- `JX8304M-三相交流采集器.pdf` (三相電表)

| 設備 | RTU 地址 | 用途 |
|------|----------|------|
| DC 電表 | 1 | DC 12V/24V 電力監測 |
| AC110 電表 | 2 | AC 110V 單相電力監測 |
| AC220 電表 | 3 | AC 220V 單相電力監測 |
| AC220 3P 電表 | 4 | AC 220V 三相電力監測 |

---

## 4. 繼電器 IO 模組 (1台)

**連接埠**: USB-Enhanced-SERIAL-D (CH344)
**UART 設定**: 115200 / 8 / NONE / 1
**MODBUS RTU 地址**: 1

**設備規格**: Waveshare Modbus RTU Relay (D)
**參考文檔**: [Waveshare Modbus RTU Relay (D) 官方文檔](https://www.waveshare.net/wiki/Modbus_RTU_Relay_(D))

### 繼電器通道配置

| 通道 | 功能 | 說明 |
|------|------|------|
| CH1 | 電磁閥 A 控制 | 真空/正壓測試管路切換 |
| CH2 | 電磁閥 B 控制 | 真空/正壓測試管路切換 |
| CH3 | 電磁閥 C 控制 | 真空/正壓測試管路切換 |
| CH4 | 電磁閥 D 控制 | 真空/正壓測試管路切換 |
| CH5 | DC 電源供電開關 | 控制待測幫浦 DC 電源 |
| CH6 | AC110V 電源供電開關 | 控制待測幫浦 AC110V 電源 |
| CH7 | AC220V 電源供電開關 | 控制待測幫浦 AC220V 電源 |
| CH8 | AC220V 3P 電源供電開關 | 控制待測幫浦 AC220V 三相電源 |

### 數位輸入配置

| Bit | 功能 | 狀態定義 |
|-----|------|----------|
| Bit0 | 緊急停止鈕 | 1 = 按下, 0 = 未按下 |
| Bit1 | 測試蓋狀態 | 1 = 關蓋, 0 = 開蓋 |

**⚠️ 注意**: 電磁閥 A/B/C/D 的組合控制模式（真空/正壓/手動測試）將於後續文件中定義。

---


## 5. 繼電器控制指令

**⚠️ 重要格式說明** (根據 Waveshare Modbus RTU Relay (D) 規格書):
- **功能碼**: 
  - `0x05`: 控制單個繼電器（Write Single Coil）
  - `0x0F`: 控制多個繼電器（Write Multiple Coils）
- **線圈地址**: 0x0000-0x0007 對應 CH1-CH8
- **控制值**: `0xFF00` = 開啟 (ON), `0x0000` = 關閉 (OFF)

### 5.1 全部關閉指令

**使用時機**: 測試停止 / 緊急停止 / 測試完成

**方法 1: 使用 0x0F 功能碼控制全部繼電器**
```
01 0F 00 00 00 08 01 00 50 0F
```
- 設備地址: `01`
- 功能碼: `0F` (Write Multiple Coils)
- 起始地址: `00 00` (0x0000)
- 線圈數量: `00 08` (8 個繼電器)
- 字節數: `01` (1 byte)
- 數據: `00` (全部關閉，bit 0-7 = 0)
- CRC: `50 0F`

**方法 2: 使用 0x05 功能碼（原始指令，需確認）**
```
01 05 00 FF 00 00 FD FA
```

**說明**: 關閉所有繼電器輸出（CH1~CH8 全部 OFF）

**⚠️ 注意**: 根據 Waveshare 規格書，標準方式應使用 `0x0F` 功能碼控制多個繼電器。`0x05` 功能碼僅用於控制單個繼電器。建議在實際測試時確認 `01 05 00 FF 00 00 FD FA` 指令是否為設備的特殊指令。

---

### 5.2 電源啟動指令

**⚠️ 前提條件** (安全聯鎖):
- ✅ **Bit1 = 1** (測試蓋必須關閉)
- ✅ **Bit0 = 0** (緊急停止鈕未按下)
- ❌ 若不符合條件，**禁止啟動**

**指令格式** (根據 Waveshare 規格書):
- 功能碼: `0x05` (Write Single Coil)
- 線圈地址: `0x0004-0x0007` 對應 CH5-CH8
- 控制值: `0xFF00` = 開啟 (ON)

| 電源類型 | MODBUS 指令 | 線圈地址 | 說明 |
|---------|------------|---------|------|
| DC 電源 | `01 05 00 04 FF 00 CD FB` | 0x0004 | 開啟 CH5 |
| AC110V | `01 05 00 05 FF 00 9C 3B` | 0x0005 | 開啟 CH6 |
| AC220V | `01 05 00 06 FF 00 6C 3B` | 0x0006 | 開啟 CH7 |
| AC220V 3P | `01 05 00 07 FF 00 3D FB` | 0x0007 | 開啟 CH8 |

**指令解析範例** (DC 電源):
```
01 05 00 04 FF 00 CD FB
```
- 設備地址: `01`
- 功能碼: `05` (Write Single Coil)
- 線圈地址: `00 04` (0x0004 = CH5)
- 控制值: `FF 00` (0xFF00 = 開啟)
- CRC: `CD FB`

---

### 5.3 電源暫停/關閉指令

**使用時機**: 暫停測試 / 測試中開蓋

**指令格式** (根據 Waveshare 規格書):
- 功能碼: `0x05` (Write Single Coil)
- 線圈地址: `0x0004-0x0007` 對應 CH5-CH8
- 控制值: `0x0000` = 關閉 (OFF)

| 電源類型 | MODBUS 指令 | 線圈地址 | 說明 |
|---------|------------|---------|------|
| DC 電源 | `01 05 00 04 00 00 8C 0B` | 0x0004 | 關閉 CH5 |
| AC110V | `01 05 00 05 00 00 DD CB` | 0x0005 | 關閉 CH6 |
| AC220V | `01 05 00 06 00 00 2D CB` | 0x0006 | 關閉 CH7 |
| AC220V 3P | `01 05 00 07 00 00 7C 0B` | 0x0007 | 關閉 CH8 |

**指令解析範例** (DC 電源):
```
01 05 00 04 00 00 8C 0B
```
- 設備地址: `01`
- 功能碼: `05` (Write Single Coil)
- 線圈地址: `00 04` (0x0004 = CH5)
- 控制值: `00 00` (0x0000 = 關閉)
- CRC: `8C 0B`

---

### 5.4 電磁閥控制指令

**指令格式** (根據 Waveshare 規格書):
- 功能碼: `0x05` (Write Single Coil)
- 線圈地址: `0x0000-0x0003` 對應 CH1-CH4
- 控制值: `0xFF00` = 開啟 (ON), `0x0000` = 關閉 (OFF)

**⚠️ 待確認**: 電磁閥 A/B/C/D (CH1~CH4) 的完整控制指令需實際測試確認 CRC 值。

**推測指令格式** (需實際驗證 CRC):
```
// 開啟指令
01 05 00 00 FF 00 [CRC]  // 開啟 CH1 (電磁閥 A)
01 05 00 01 FF 00 [CRC]  // 開啟 CH2 (電磁閥 B)
01 05 00 02 FF 00 [CRC]  // 開啟 CH3 (電磁閥 C)
01 05 00 03 FF 00 [CRC]  // 開啟 CH4 (電磁閥 D)

// 關閉指令
01 05 00 00 00 00 [CRC]  // 關閉 CH1 (電磁閥 A)
01 05 00 01 00 00 [CRC]  // 關閉 CH2 (電磁閥 B)
01 05 00 02 00 00 [CRC]  // 關閉 CH3 (電磁閥 C)
01 05 00 03 00 00 [CRC]  // 關閉 CH4 (電磁閥 D)
```

**指令格式說明**:
- 設備地址: `01`
- 功能碼: `05` (Write Single Coil)
- 線圈地址: `00 00` (CH1), `00 01` (CH2), `00 02` (CH3), `00 03` (CH4)
- 控制值: `FF 00` (開啟) 或 `00 00` (關閉)
- CRC: 需計算 CRC-16 Modbus 校驗碼

**📝 實作前必須確認**:
- [ ] 計算並驗證正確的 CRC-16 Modbus 校驗碼
- [ ] 確認電磁閥控制指令與實際硬體一致
- [ ] 測試電磁閥動作是否正常

**具體組合模式** (真空/正壓/手動測試) 將於後續文件定義。

---


## 6. 感測器讀取指令

### 6.1 電表讀取指令

**功能碼**: 0x03 (Read Holding Registers)
**輪詢頻率**: 0.5 秒 1 次 (2 Hz)

| 設備 | RTU 地址 | MODBUS 指令 | 讀取長度 |
|------|----------|------------|---------|
| DC 電表 | 1 | `01 03 10 00 00 04 40 C9` | 4 個寄存器 (8 bytes)<br>**注意**: 讀取 2 個 Int32 參數（電壓、電流）<br>如需讀取功率，需讀取 8 個寄存器：`01 03 10 00 00 08` |
| AC110V 電表 | 2 | `02 03 10 00 00 04 40 FA` | 4 個寄存器 (8 bytes)<br>**注意**: 讀取 2 個 Int32 參數（電壓、電流）<br>如需讀取功率，需讀取 8 個寄存器：`02 03 10 00 00 08` |
| AC220V 電表 | 3 | `03 03 10 00 00 04 41 2B` | 4 個寄存器 (8 bytes)<br>**注意**: 讀取 2 個 Int32 參數（電壓、電流）<br>如需讀取功率，需讀取 8 個寄存器：`03 03 10 00 00 08` |
| AC220V 3P 電表 | 4 | `04 03 10 00 00 11 81 53` | **17 個寄存器 (34 bytes)** ⭐<br>**注意**: 讀取 17 個寄存器可容納 8 個完整的 Int32 參數（32 bytes）+ 1 個額外寄存器（2 bytes） |

---

### 6.2 壓力計讀取指令

**功能碼**: 0x03 (Read Holding Registers)
**輪詢頻率**: 1 秒 1 次 (1 Hz)

| 設備 | RTU 地址 | MODBUS 指令 |
|------|----------|------------|
| 壓力計 右 (正壓) | 2 | `02 03 10 00 00 01 80 F9` |
| 壓力計 左 (真空) | 3 | `03 03 10 00 00 01 81 28` |

---

### 6.3 流量計讀取指令

**功能碼**: 0x03 (Read Holding Registers)
**輪詢頻率**: 1 秒 1 次 (1 Hz)

| 設備 | RTU 地址 | MODBUS 指令 | 讀取內容 |
|------|----------|------------|---------|
| 流量計 | 1 | `01 03 00 00 00 01 84 0A` | 瞬时流量（1 個寄存器） |
| 流量計 | 1 | `01 03 00 01 00 02 [CRC]` | 累計流量（2 個寄存器，32 位元） |

**寄存器地址** (根據 AFM07 規格書):
- **0x0000**: 瞬时流量（16 位元，只讀，倍數 10）
- **0x0001**: 累計流量高 16 位（只讀，倍數 10）
- **0x0002**: 累計流量低 16 位（只讀，倍數 10）

---

### 6.4 IO 模組讀取指令

**功能碼**: 0x02 (Read Discrete Inputs) - 根據 Waveshare 規格書
**輪詢頻率**: 0.01 秒 1 次 (100 Hz) - **高頻率用於安全監控**

| 設備 | RTU 地址 | MODBUS 指令 | 說明 |
|------|----------|------------|------|
| IO 模組 | 1 | `01 02 00 00 00 08 79 CC` | 讀取 8 個數字輸入狀態 |

**指令解析** (根據 Waveshare 規格書):
```
01 02 00 00 00 08 79 CC
```
- 設備地址: `01`
- 功能碼: `02` (Read Discrete Inputs)
- 起始地址: `00 00` (0x0000)
- 輸入數量: `00 08` (8 個輸入)
- CRC: `79 CC`

**⚠️ 重要**: 
- IO 模組需高頻輪詢以即時偵測緊急停止與測試蓋狀態
- 根據 Waveshare 規格書，數字輸入變化後約需 75ms 才能採集到變化（包含指令發送和接收時間）

---


## 7. 感測器回應資料格式

### 7.1 電表回應格式

#### 7.1.1 單相電表回應格式 (DC / AC110V / AC220V)

**⚠️ 重要格式說明** (根據 JX3101-7101-7102-7202 規格書):
- **所有數據都是 Int32（32 位元整數）**，每個參數佔用 **2 個寄存器（4 bytes）**
- 資料格式：高位在前 (Big-Endian)，每個 Int32 由 2 個連續的 16 位元寄存器組成
- 負數使用補碼格式存儲，最高位為符號位

**回應範例** (DC 電表):
```
01 03 08 00 00 00 00 00 00 00 00 95 D7
```

**資料解析** (DC/AC110V/AC220V 格式相同):

**⚠️ 注意**: 目前讀取指令 `01 03 10 00 00 04` 讀取 4 個寄存器（8 bytes），只能讀取 **2 個 Int32 參數**。

| Byte 位置 | 參數名稱 | 資料類型 | 換算公式 | 單位 | 說明 |
|-----------|---------|---------|---------|------|------|
| Byte 4-7 | 有效電壓 | **Signed Int32** (2 個寄存器) | Int32 ÷ 100 | V | 從 0x1000 開始 |
| Byte 8-11 | 有效電流 | **Signed Int32** (2 個寄存器) | Int32 ÷ 1000 | A | 從 0x1002 開始 |

**如需讀取更多參數**，需增加讀取寄存器數量：
- 有功功率：0x1004-0x1005（Int32，2個寄存器）
- 無功功率：0x1006-0x1007（Int32，2個寄存器）
- 讀取 4 個參數（電壓、電流、功率、無功功率）需要 **8 個寄存器（16 bytes）**：`01 03 10 00 00 08`

**範例計算** (根據規格書):
```
有效電壓：Byte 4-7 = 0x000055F0 → Int32 = 22000 → 22000 ÷ 100 = 220.0 V
有效電流：Byte 8-11 = 0x00000FA0 → Int32 = 4000 → 4000 ÷ 1000 = 4.000 A
有功功率：Byte 12-15 = 0xFFFFD508 → Int32 = -11000 → -11000 ÷ 10000 = -1.1 kW
```

**回應範例**:
- DC 電表: `01 03 08 00 00 00 00 00 00 00 00 95 D7` (目前只讀取電壓和電流)
- AC110V: `02 03 08 00 00 00 00 00 00 00 00 9A 93` (目前只讀取電壓和電流)
- AC220V: `03 03 08 00 00 00 00 00 00 00 00 9E 6F` (目前只讀取電壓和電流)

---

#### 7.1.2 三相電表回應格式 (AC220V 3P) ⭐

**回應範例** (AC220V 3P):
```
04 03 22 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 DD 13
```

**資料長度**: 0x22 = 34 bytes (17 個寄存器)

**資料解析**:

**⚠️ 重要格式說明** (根據 JX8304M 規格書):
- **所有數據都是 Int32（32 位元整數）**，每個參數佔用 **2 個寄存器（4 bytes）**
- 資料格式：高位在前 (Big-Endian)，每個 Int32 由 2 個連續的 16 位元寄存器組成
- 負數使用補碼格式存儲，最高位為符號位

| Byte 位置 | 參數名稱 | 資料類型 | 換算公式 | 單位 | 說明 |
|-----------|---------|---------|---------|------|------|
| Byte 4-7 | A 相電壓有效值 | **Signed Int32** (2 個寄存器) | Int32 ÷ 100 | V | Phase A Voltage |
| Byte 8-11 | B 相電壓有效值 | **Signed Int32** (2 個寄存器) | Int32 ÷ 100 | V | Phase B Voltage |
| Byte 12-15 | C 相電壓有效值 | **Signed Int32** (2 個寄存器) | Int32 ÷ 100 | V | Phase C Voltage |
| Byte 16-19 | A 相電流有效值 | **Signed Int32** (2 個寄存器) | Int32 ÷ 1000 | A | Phase A Current |
| Byte 20-23 | B 相電流有效值 | **Signed Int32** (2 個寄存器) | Int32 ÷ 1000 | A | Phase B Current |
| Byte 24-27 | C 相電流有效值 | **Signed Int32** (2 個寄存器) | Int32 ÷ 1000 | A | Phase C Current |
| Byte 28-31 | 0 相電流有效值 (漏電流) | **Signed Int32** (2 個寄存器) | Int32 ÷ 1000 | A | Neutral/Leakage Current |
| Byte 32-35 | A 相有功功率 | **Signed Int32** (2 個寄存器) | Int32 ÷ 10000 | kW | Phase A Active Power |
| Byte 36-39 | B 相有功功率 | **Signed Int32** (2 個寄存器) | Int32 ÷ 10000 | kW | Phase B Active Power |
| Byte 40-43 | C 相有功功率 | **Signed Int32** (2 個寄存器) | Int32 ÷ 10000 | kW | Phase C Active Power |
| Byte 44-47 | 合相有功功率 | **Signed Int32** (2 個寄存器) | Int32 ÷ 10000 | kW | **Total Active Power** |

**📝 實作注意事項**:
- **所有參數都需要解析為 Int32**，而非 16 位元整數
- 解析方法：將 4 個連續 bytes 組合為 32 位元有符號整數（高位在前）
- 範例解析（根據 JX8304M 規格書）：
  - A相電壓：`Byte 4-7 = 0x000055F0` → Int32 = 22000 → 22000 ÷ 100 = 220.0 V
  - A相有功功率：`Byte 32-35 = 0xFFFFD508` → Int32 = -11000 → -11000 ÷ 10000 = -1.1 kW
- 負數表示反向（如電流為負表示反向電流，功率為負表示反向功率）
- **讀取範圍說明**: 讀取指令 `04 03 10 00 00 11` 讀取 17 個寄存器（34 bytes）
  - 可容納 8 個完整的 Int32 參數（32 bytes）+ 1 個額外寄存器（2 bytes）
  - 實際讀取的參數範圍需根據系統需求確認
  - 如需讀取所有 11 個參數，需讀取 22 個寄存器（44 bytes）：`04 03 10 00 00 16`
- 三相電表回應長度為 **34 bytes**（17 個寄存器），遠大於單相電表的 8 bytes

---

### 7.2 壓力計回應格式

**⚠️ 重要格式說明** (根據 Delta DPA 規格書):
- **寄存器地址**: 0x1000 (1000H) = PV 值（壓力值）
- **數據類型**: **Unsigned Int16** (16位元無符號整數)，1 個寄存器（2 bytes）
- **計量單位**: 0.1（讀取值需乘以 0.1 得到實際壓力值）
- **功能碼**: 0x03 (最多可讀取 8 個寄存器)
- **通訊協定**: RTU 或 ASCII（本系統使用 RTU）

**回應範例** (正壓):
```
02 03 02 00 00 FC 44
```
- 從機地址: `02`
- 功能碼: `03`
- 數據長度: `02` (2 bytes = 1 個寄存器)
- 壓力數據: `00 00` (0x0000 = 0 dec)
- CRC: `FC 44`

**回應範例** (真空):
```
03 03 02 00 00 C1 84
```
- 從機地址: `03`
- 功能碼: `03`
- 數據長度: `02` (2 bytes = 1 個寄存器)
- 壓力數據: `00 00` (0x0000 = 0 dec)
- CRC: `C1 84`

**資料解析**:

| Byte 位置 | 參數名稱 | 數據類型 | 換算公式 | 單位 | 範圍 |
|-----------|---------|---------|---------|------|------|
| Byte 4-5 (正壓) | 正壓壓力值 | Unsigned Int16 | Hex → Dec × 0.1 | kg/cm² | 0 ~ 10 kg/cm² (0 ~ 1.0 MPa) |
| Byte 4-5 (真空) | 真空壓力值 | Unsigned Int16 | Hex → Dec × 0.1 | kPa | 0 ~ -100 kPa (0 ~ -0.1 MPa) |

**⚠️ 注意**: 
- 根據 Delta DPA 規格書，寄存器 1000H 的 PV 值計量單位為 **0.1**
- 讀取的數值需要 **乘以 0.1** 才能得到實際壓力值
- 壓力單位可透過寄存器 1008H 設定（0:KPa/MPa, 1:Kgf, 2:Bar 等）
- 本系統預設使用 **kg/cm²** 作為正壓單位，**kPa** 作為真空單位

**範例計算**:
```
正壓範例: Byte 4-5 = 0x00DA (218 dec)
  → 218 × 0.1 = 21.8 kg/cm² = 2.18 MPa

真空範例: Byte 4-5 = 0xFFCE (65486 dec, 作為有符號數為 -50)
  → -50 × 0.1 = -5.0 kPa = -0.005 MPa
```

**⚠️ 單位轉換**:
- 1 MPa = 10 kg/cm² = 1000 kPa
- 正壓範圍: 0 ~ 10 kg/cm² = 0 ~ 1.0 MPa
- 真空範圍: 0 ~ -100 kPa = 0 ~ -0.1 MPa

---

### 7.3 流量計回應格式

**⚠️ 重要格式說明** (根據 AFM07 規格書):
- **瞬时流量**: 16 位元無符號整數（1 個寄存器，2 bytes），倍數 10
- **累計流量**: 32 位元無符號整數（2 個寄存器，4 bytes），倍數 10

#### 7.3.1 瞬时流量回應格式

**回應範例** (讀取瞬时流量):
```
01 03 02 00 DA 39 DF
```

**資料解析**:

| Byte 位置 | 參數名稱 | 資料類型 | 換算公式 | 單位 | 說明 |
|-----------|---------|---------|---------|------|------|
| Byte 4-5 | 瞬时流量 | **Unsigned Int16** (1 個寄存器) | Hex → Dec ÷ 10 | L/min | 從 0x0000 讀取 |

**範例計算** (根據規格書):
```
Byte 4-5 = 0x00DA (218 dec) → 218 ÷ 10 = 21.8 L/min
```

#### 7.3.2 累計流量回應格式

**回應範例** (讀取累計流量):
```
01 03 04 49 96 02 D7 [CRC]
```

**資料解析**:

| Byte 位置 | 參數名稱 | 資料類型 | 換算公式 | 單位 | 說明 |
|-----------|---------|---------|---------|------|------|
| Byte 4-5 | 累計流量高 16 位 | **Unsigned Int16** | 高 16 位 | - | 從 0x0001 讀取 |
| Byte 6-7 | 累計流量低 16 位 | **Unsigned Int16** | 低 16 位 | - | 從 0x0002 讀取 |
| Byte 4-7 | 累計流量（組合） | **Unsigned Int32** (2 個寄存器) | (高16位 << 16 \| 低16位) ÷ 10 | L | 32 位元組合值 |

**範例計算**:
```
高 16 位：Byte 4-5 = 0x4996 (18838 dec)
低 16 位：Byte 6-7 = 0x02D7 (727 dec)
組合值：0x499602D7 = 18838 × 65536 + 727 = 1234567890 dec
累計流量：1234567890 ÷ 10 = 123456789.0 L
```

---

### 7.4 IO 模組回應格式

**⚠️ 重要格式說明** (根據 Waveshare Modbus RTU Relay (D) 規格書):
- **功能碼**: 0x02 (Read Discrete Inputs)
- **回應格式**: 設備地址 + 功能碼 + 字節數 + 輸入狀態數據 + CRC
- **輸入數量**: 8 個數字輸入（Bit 0-7）

**回應範例**:
```
01 02 01 00 A1 88
```

**回應解析**:
- 設備地址: `01`
- 功能碼: `02` (Read Discrete Inputs)
- 字節數: `01` (1 byte，包含 8 個輸入狀態)
- 輸入狀態: `00` (所有輸入為 0)
- CRC: `A1 88`

**資料解析**:

| Byte 位置 | 參數名稱 | 位元定義 | 說明 |
|-----------|---------|---------|------|
| Byte 4 | 數位輸入狀態 | Bit 0-7 | 8 個輸入通道狀態 |

**Bit 定義**:
- **Bit 0**: 緊急停止鈕狀態 (1 = 按下, 0 = 未按下)
- **Bit 1**: 測試蓋狀態 (1 = 關蓋, 0 = 開蓋)
- **Bit 2-7**: 保留 (未使用)

**範例解析**:
```
回應: 01 02 01 00 A1 88
Byte 4 = 0x00 (00000000 binary)
→ Bit 0 = 0 (緊急停止未按下)
→ Bit 1 = 0 (測試蓋未關閉)
→ 狀態: 無法啟動測試（測試蓋未關閉）

回應: 01 02 01 02 A1 88 (假設)
Byte 4 = 0x02 (00000010 binary)
→ Bit 0 = 0 (緊急停止未按下)
→ Bit 1 = 1 (測試蓋已關閉)
→ 狀態: 可以啟動測試
```

**⚠️ 注意**: 
- 根據 Waveshare 規格書，數字輸入變化後約需 75ms 才能採集到變化
- 回應中的字節數為 1，表示返回 1 個字節（8 個輸入狀態）

---

## 8. 安全聯鎖邏輯

### 8.1 啟動測試前檢查

Python 後端必須強制執行以下安全檢查：

```python
# 讀取 IO 模組狀態
io_status = read_io_module()  # Byte 4
emergency_stop = (io_status & 0x01) != 0  # Bit 0
cover_closed = (io_status & 0x02) != 0    # Bit 1

# 安全聯鎖判斷
if emergency_stop:
    # ❌ 緊急停止按下，禁止啟動
    return "錯誤: 緊急停止鈕已按下，請解除後再試"

if not cover_closed:
    # ❌ 測試蓋未關閉，禁止啟動
    return "錯誤: 測試蓋未關閉，請關閉後再試"

# ✅ 安全檢查通過，允許啟動
send_power_on_command()
```

---

### 8.2 測試中持續監控

系統必須以 **100 Hz (0.01秒)** 頻率持續監控 IO 狀態：

| 偵測到的狀態變化 | 系統反應 |
|-----------------|----------|
| **緊急停止按下** (Bit0 = 1) | 1. 立即切斷所有電源 (`01 05 00 FF 00 00 FD FA`)<br>2. 洩壓 (開啟電磁閥 A/B)<br>3. 鎖定所有操作<br>4. 顯示 "🚨 緊急停止" |
| **測試蓋開啟** (Bit1 = 0) | 1. 停止幫浦供電 (關閉對應 CH5~8)<br>2. 進入 **暫停狀態**<br>3. 顯示 "⚠️ 測試蓋開啟 - 已暫停"<br>4. 蓋上後可繼續測試 |

---

### 8.3 恢復測試條件

| 暫停原因 | 恢復條件 |
|---------|---------|
| 測試蓋開啟 | 檢測到 Bit1 = 1 (蓋上) → 可按 "繼續測試" |
| 緊急停止 | 檢測到 Bit0 = 0 (解除) → 必須重新啟動測試流程 |

---

## 9. 實際硬體驗證待確認項目

以下項目需在實際硬體測試時驗證：

### 9.1 電磁閥控制指令 (優先級: 高)
- [ ] **CH1~CH4 的完整 MODBUS 指令**（含正確 CRC）
- [ ] 驗證電磁閥動作是否與指令對應
- [ ] 確認電磁閥組合模式（真空/正壓測試的 A/B/C/D 開關邏輯）

### 9.2 壓力計單位與換算公式 (優先級: 高)
- [ ] **確認壓力計實際回傳單位**
  - 正壓: 是 MPa? kPa? 還是 kg/cm²?
  - 真空: 是 MPa? kPa? 還是其他單位?
- [ ] **驗證換算公式**
  - 測試數值範例: `0x00DA` 應對應多少實際壓力?
  - 確認除以 10 的倍率是否正確
- [ ] **測試極限值**
  - 正壓最大值 (應為 10 kg/cm² 或 1.0 MPa)
  - 真空最大值 (應為 -100 kPa 或 -0.1 MPa)

### 9.3 寄存器起始地址驗證 (優先級: 中)
不同設備使用不同的寄存器起始地址，需確認是否與設備規格書一致：
- [ ] 壓力計: `0x1000` (4096) - 起始地址正確?
- [ ] 流量計: `0x0000` (0) - 起始地址正確?
- [ ] 電表: `0x1000` (4096) - 起始地址正確?

### 9.4 流量計量測範圍 (優先級: 低)
- [ ] 確認流量計最大測量範圍 (L/min)
- [ ] 驗證換算公式 (除以 10) 是否正確

### 9.5 IO 模組測試 (優先級: 高)
- [ ] 實際測試緊急停止按鈕觸發 (Bit 0 = 1)
- [ ] 實際測試測試蓋開關偵測 (Bit 1 = 0/1)
- [ ] 驗證 100 Hz 輪詢頻率是否穩定
- [ ] 測試安全聯鎖邏輯是否正確執行

---

## 10. 文件修訂記錄

| 版本 | 日期 | 修訂內容 |
|------|------|---------|
| 1.0 | 2025.11.12 | 初版發布 |
| 1.1 | 2025.11.15 | 1. 新增壓力計量測範圍說明 (MPa/kPa/kg/cm²)<br>2. 明確定義電磁閥 A/B/C/D 對應 CH1~CH4<br>3. 新增安全聯鎖邏輯詳細說明<br>4. 重新組織文件結構，提升可讀性<br>5. 保留原始技術筆記於附錄 |
| 1.2 | 2025.11.15 | **技術審查修正**:<br>1. 修正 USB 轉換器數量: 3→4 個<br>2. 修正 Python 位元檢查邏輯 (`!= 0`)<br>3. 修正位元範圍描述 (bit 0-8 → bit 0-7)<br>4. 新增電磁閥控制指令推測格式<br>5. **新增「實際硬體驗證待確認項目」章節**<br>6. 標註需實測驗證的項目 (壓力單位/CRC/寄存器地址) |
| 1.3 | 2025.11.15 | **工程師更新 - AC220V 3P 電表規格**:<br>1. ⭐ **修正 AC220V 3P 讀取指令**: `04 03 10 00 00 11 81 53` (17 個寄存器)<br>2. ⭐ **更新 AC220V 3P 回應格式**: 34 bytes (詳細三相數據)<br>3. 新增三相電表資料解析 (A/B/C 相電壓、電流、功率)<br>4. 新增漏電流 (0 相) 監測<br>5. 標註合相功率為有符號 Int32 |
| 1.4 | 2025.11.15 | **技術修正**:<br>1. 修正原始筆記中 IO 位元範圍描述 (bit 0-8 → bit 0-7)<br>2. ⭐ **修正合相功率資料格式說明**: 明確標註為 Byte 24-27 (2 個寄存器，4 bytes)<br>3. 新增合相功率解析範例與實作注意事項 |
| 1.5 | 2025.11.15 | **⭐ 根據 JX8304M 規格書重大修正**:<br>1. **所有參數格式修正**: 根據規格書，所有數據（電壓/電流/功率）都是 **Int32（32位元整數）**，每個參數佔用 **2 個寄存器（4 bytes）**<br>2. **修正 Byte 位置映射**: 所有參數的 Byte 位置重新計算（每個參數 4 bytes）<br>3. 新增完整的資料解析表格，標註所有參數的資料類型<br>4. 更新原始筆記中的格式說明 |
| 1.6 | 2025.11.15 | **⭐ 根據 JX3101-7101-7102-7202 規格書重大修正**:<br>1. **單相電表格式修正**: 根據規格書，所有數據（電壓/電流/功率）都是 **Int32（32位元整數）**，每個參數佔用 **2 個寄存器（4 bytes）**<br>2. **修正讀取範圍說明**: 目前讀取指令只讀取 4 個寄存器（2 個參數：電壓、電流）<br>3. **標註完整讀取指令**: 如需讀取 4 個參數（電壓、電流、功率、無功功率），需讀取 8 個寄存器（16 bytes）<br>4. 更新單相電表資料解析表格，標註所有參數的資料類型<br>5. 更新原始筆記中的格式說明 |
| 1.7 | 2025.11.15 | **⭐ 根據 AFM07 規格書修正流量計格式**:<br>1. **流量計格式說明**: 根據規格書，瞬时流量為 **Unsigned Int16（16位元整數）**，1 個寄存器（2 bytes）<br>2. **新增累計流量說明**: 累計流量為 **Unsigned Int32（32位元整數）**，2 個寄存器（4 bytes）<br>3. 更新回應範例為規格書中的實際範例<br>4. 新增累計流量讀取指令和解析說明<br>5. 更新原始筆記中的格式說明 |
| 1.8 | 2025.11.15 | **⭐ 根據 Delta DPA 規格書修正壓力計格式**:<br>1. **壓力計格式說明**: 根據規格書，壓力值為 **Unsigned Int16（16位元無符號整數）**，1 個寄存器（2 bytes）<br>2. **修正換算公式**: 計量單位為 0.1，讀取值需 **乘以 0.1**（而非除以 10）<br>3. **寄存器地址確認**: 0x1000 (1000H) = PV 值（壓力值）<br>4. 新增功能碼說明（0x03，最多可讀取 8 個寄存器）<br>5. 修正範例計算，明確標註數據類型和換算方式<br>6. 新增壓力單位設定說明（寄存器 1008H） |
| 1.9 | 2025.11.15 | **⭐ 根據 Waveshare Modbus RTU Relay (D) 規格書更新繼電器 IO 模組**:<br>1. **新增設備規格和參考文檔連結**: [Waveshare Modbus RTU Relay (D) 官方文檔](https://www.waveshare.net/wiki/Modbus_RTU_Relay_(D))<br>2. **功能碼說明**: 明確標註 0x05 (Write Single Coil) 和 0x0F (Write Multiple Coils)<br>3. **線圈地址映射**: 0x0000-0x0007 對應 CH1-CH8<br>4. **控制值說明**: 0xFF00 = 開啟, 0x0000 = 關閉<br>5. **全部關閉指令**: 新增使用 0x0F 功能碼的標準方式<br>6. **指令解析**: 為所有控制指令添加詳細的位元組解析說明<br>7. **IO 讀取指令**: 新增指令格式說明和輸入變化採集時間（約 75ms）<br>8. **IO 回應格式**: 新增回應格式說明和更詳細的範例解析 |

---

## 附錄：原始工程師技術筆記 (僅供參考)

以下為工程師提供的原始開發筆記，已整合至上方正式文件中，此處保留供快速技術參考使用。

**最後更新**: 2025.11.15 (包含 AC220V 3P 電表更新)

---

### 原始設備配置筆記

```
流量計(1台) 連結USB-Enhanced -SERIAL-C CH344 / UART 設定 19200 / 8 /NONE / 1 / RTU 地址設定 1

壓力計(2台) 連結MOXA USB Serial Port / UART 設定 19200 / 8 /EVEN / 1
壓力計 右 正壓 RTU 地址設定 2
壓力計 左 真空 RTU 地址設定 3

電表(4台) 連結USB-Enhanced -SERIAL-A CH344 / UART 設定 57600 / 8 /NONE / 1
AC220 3P RTU 地址設定 4
AC220 RTU 地址設定 3
AC110 RTU 地址設定 2
DC RTU 地址設定 1

繼電器IO(1台) 連結USB-Enhanced -SERIAL-D CH344 / UART 設定 115200 / 8 /NONE / 1 / RTU 地址設定 1
```

---

### 原始繼電器指令筆記

```
繼電器 指令
測試停止
01 05 00 FF 00 00 FD FA //全關

開始鍵(需要關蓋才可使用並 未 按下緊急停止鈕)
 AC
110 ->  01 05 00 05 FF 00 9C 3B // 開CH6
220 ->    01 05 00 06 FF 00 6C 3B // 開CH7
2203P -> 01 05 00 07 FF 00 3D FB // 開CH8
DC ->  01 05 00 04 FF 00 CD FB // 開CH5

暫停鍵 / 測試中開蓋
110 ->  01 05 00 05 00 00 DD CB // 關CH6
220 ->    01 05 00 06 00 00 2D CB // 關CH7
2203P -> 01 05 00 07 00 00 7C 0B // 關CH8
DC ->  01 05 00 04 00 00 8C 0B // 關CH5

關閉鍵 / 按下緊急停止鈕 /測試完成
01 05 00 FF 00 00 FD FA //全關
```

---

### 原始讀取指令與回應筆記

```
COM讀取與返回
DC 讀取指令 01 03 10 00 00 04 40 C9 讀取 0.5秒 1次
AC110 讀取指令 02 03 10 00 00 04 40 FA 0.5秒 1次
AC220 讀取指令 03 03 10 00 00 04 41 2B 0.5秒 1次
AC220 3P 讀取指令 04 03 10 00 00 11 81 53 0.5秒 1次
IO 讀取 01 02 00 00 00 08 79 CC 讀取 0.01秒 1次
流量 讀取 01 03 00 00 00 01 84 0A 讀取 1秒 1次
壓力 右 正壓 讀取 02 03 10 00 00 01 80 F9 讀取 1秒 1次
壓力 左 真空 讀取 03 03 10 00 00 01 81 28 讀取 1秒 1次


DC 返回 01 03 08 00 00 00 00 00 00 00 00 95 D7
⚠️ 重要：根據 JX3101 規格書，**所有參數都是 Int32（32位元整數）**，每個參數佔用 2 個寄存器（4 bytes）
目前讀取指令只讀取 4 個寄存器（8 bytes），只能讀取 2 個參數：
位元 4-7 ：有效电压：有符号Int32（2個寄存器，4 bytes），单位V，结果=数据/100
位元 8-11：有效電流：有符号Int32（2個寄存器，4 bytes），单位A，结果=数据/1000
注意：如需讀取有功功率和無功功率，需讀取 8 個寄存器（16 bytes）

AC110 返回 02 03 08 00 00 00 00 00 00 00 00 9A 93
⚠️ 重要：根據 JX3101 規格書，**所有參數都是 Int32（32位元整數）**，每個參數佔用 2 個寄存器（4 bytes）
目前讀取指令只讀取 4 個寄存器（8 bytes），只能讀取 2 個參數：
位元 4-7 ：有效电压：有符号Int32（2個寄存器，4 bytes），单位V，结果=数据/100
位元 8-11：有效電流：有符号Int32（2個寄存器，4 bytes），单位A，结果=数据/1000
注意：如需讀取有功功率和無功功率，需讀取 8 個寄存器（16 bytes）

AC220 返回 03 03 08 00 00 00 00 00 00 00 00 9E 6F
⚠️ 重要：根據 JX3101 規格書，**所有參數都是 Int32（32位元整數）**，每個參數佔用 2 個寄存器（4 bytes）
目前讀取指令只讀取 4 個寄存器（8 bytes），只能讀取 2 個參數：
位元 4-7 ：有效电压：有符号Int32（2個寄存器，4 bytes），单位V，结果=数据/100
位元 8-11：有效電流：有符号Int32（2個寄存器，4 bytes），单位A，结果=数据/1000
注意：如需讀取有功功率和無功功率，需讀取 8 個寄存器（16 bytes）

AC220 3P 返回 04 03 22 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 DD 13
⚠️ 重要：根據 JX8304M 規格書，**所有參數都是 Int32（32位元整數）**，每個參數佔用 2 個寄存器（4 bytes）
位元 4-7 ：A相电压有效值：有符号Int32（2個寄存器，4 bytes），单位V，结果=数据/100
位元 8-11：B相电压有效值：有符号Int32（2個寄存器，4 bytes），单位V，结果=数据/100
位元 12-15：C相电压有效值：有符号Int32（2個寄存器，4 bytes），单位V，结果=数据/100
位元 16-19：A相电流有效值：有符号Int32（2個寄存器，4 bytes），单位A，结果=数据/1000
位元 20-23：B相电流有效值：有符号Int32（2個寄存器，4 bytes），单位A，结果=数据/1000
位元 24-27：C相电流有效值：有符号Int32（2個寄存器，4 bytes），单位A，结果=数据/1000
位元 28-31：0相（漏电流）电流有效值：有符号Int32（2個寄存器，4 bytes），单位A，结果=数据/1000
位元 32-35：A相有功功率：有符号Int32（2個寄存器，4 bytes），单位kW，结果=数据/10000
位元 36-39：B相有功功率：有符号Int32（2個寄存器，4 bytes），单位kW，结果=数据/10000
位元 40-43：C相有功功率：有符号Int32（2個寄存器，4 bytes），单位kW，结果=数据/10000
位元 44-47：合相有功功率：有符号Int32（2個寄存器，4 bytes），单位kW，结果=数据/10000
注意：所有參數都需要讀取 4 bytes（2個寄存器）並組合為 Int32（高位在前）


IO 返回 01 02 01 00 A1 88
        位元 4 返回的输入通道状态 bit 0-7 (共 8 個位元)
        Bit0:緊急停止鈕狀態  按下 1 未按下 0；
        Bit1:門蓋狀態 開蓋 0  / 關蓋 1，

流量 返回 01 03 02 00 DA 39 DF
⚠️ 重要：根據 AFM07 規格書
瞬时流量（讀取 0x0000，1 個寄存器）：
位元 4-5 ：瞬时流量：無符號 Int16（1個寄存器，2 bytes），单位L/min，结果=数据/10
例：0x00DA (218 dec) → 218 ÷ 10 = 21.8 L/min

累計流量（讀取 0x0001-0x0002，2 個寄存器）：
位元 4-5 ：累計流量高 16 位（從 0x0001 讀取）
位元 6-7 ：累計流量低 16 位（從 0x0002 讀取）
組合為 32 位元無符號整數，結果=數據/10，單位 L

壓力 右 正壓 返回 02 03 02 00 00 FC 44
⚠️ 重要：根據 Delta DPA 規格書
位元 4-5：壓力值（Unsigned Int16，1 個寄存器，2 bytes）
計量單位：0.1（讀取值需乘以 0.1 得到實際壓力值）
寄存器地址：0x1000 (1000H) = PV 值
範例：0x00DA (218 dec) → 218 × 0.1 = 21.8 kg/cm² = 2.18 MPa
壓力 左 真空 返回 03 03 02 00 00 C1 84
⚠️ 重要：根據 Delta DPA 規格書
位元 4-5：壓力值（Unsigned Int16，1 個寄存器，2 bytes）
計量單位：0.1（讀取值需乘以 0.1 得到實際壓力值）
寄存器地址：0x1000 (1000H) = PV 值
範例：0xFFCE (65486 dec, 作為有符號數為 -50) → -50 × 0.1 = -5.0 kPa
```

---

**文件結束** 